# ADR-0003：凭证输入格式与校验策略

- Status: **Accepted**
- Date: 2026-01-13

## 背景 / Context

本工具采用浏览器会话模拟方式访问 X 网页内部接口，需要用户手动提供已登录会话的凭证（Cookies/Token）。凭证输入的设计需要平衡以下因素：

- **易用性**：用户能够从浏览器开发者工具中清晰地识别和复制所需字段。
- **可校验性**：在启动任务前能够验证凭证有效性，避免无效凭证导致的批量失败。
- **安全性**：作为本地工具，需明确凭证的存储与展示策略。

## 决策 / Decision

### 1) 凭证输入方式：分字段输入

采用分字段输入方式，每个凭证字段独立输入，UI 提供格式示例帮助用户识别。

**必填字段（最小可用集合）：**

| 字段名 | 来源 | 格式示例 | 说明 |
|--------|------|----------|------|
| `auth_token` | Cookie: `auth_token` | `abc123def456...`（约 40 字符十六进制） | 主认证令牌 |
| `ct0` | Cookie: `ct0` | `abc123def456...`（约 32 字符十六进制） | CSRF 防护令牌，随请求头 `x-csrf-token` 发送 |

**可选字段：**

| 字段名 | 来源 | 格式示例 | 说明 |
|--------|------|----------|------|
| `twid` | Cookie: `twid` | `u%3D123456789` | 用户 ID，URL 编码格式；可用于调试但非必需 |

选择理由：

- 分字段输入比"粘贴完整 Cookie 头"更清晰，降低用户误粘贴无关 Cookie 的概率。
- 明确最小字段集合（`auth_token` + `ct0`）减少用户困惑。
- 附带格式示例（字符长度、格式特征）帮助用户在浏览器 DevTools 中快速定位正确字段。

### 2) 缺失字段时的阻止启动提示

当必填字段缺失或格式明显异常时：

- **阻止所有任务启动**（Start/Continue 按钮禁用）。
- **展示明确提示文案**，指出缺失或异常的字段：

```
凭证未配置或不完整，无法启动任务。

缺失字段：
- ct0：未填写

请前往「设置 → 凭证」页面完成配置。
```

```
凭证格式异常，无法启动任务。

格式错误：
- auth_token：长度不足（期望约 40 字符，实际 10 字符）

请检查是否复制了完整的值。
```

### 3) 最小校验：轻量请求验证登录态

在用户保存凭证或首次启动任务前，执行一次轻量级请求验证凭证有效性。

**校验请求：**

- 目标：选择一个低负担的 GraphQL 端点（如获取当前用户基本信息）。
- 方式：携带配置的凭证发送请求，根据响应判断状态。

**响应解读与错误提示：**

| HTTP 状态 | 解读 | 用户提示 |
|-----------|------|----------|
| 200 + 有效数据 | 凭证有效 | "凭证验证通过" |
| 401 Unauthorized | 凭证无效或已过期 | "认证失败：凭证无效或已过期，请重新获取并粘贴" |
| 403 Forbidden | 账号受限或权限不足 | "访问被拒绝：账号可能被限制，请检查账号状态" |
| 429 Too Many Requests | 触发限流 | "请求过于频繁，请稍后再试" |
| 网络错误 | 无法连接 | "无法连接服务器，请检查网络或代理配置" |
| 其他 4xx/5xx | 未知错误 | "验证失败（HTTP {code}），请稍后重试" |

**校验时机：**

- 保存凭证时自动触发。
- 校验失败仍允许保存（用户可能需要调试），但会显示警告并记录上次校验结果。
- 启动任务时若上次校验失败超过 10 分钟，建议重新验证。

### 4) 凭证存储策略

- **允许本地存储**：凭证保存在 `data/config.json` 中，随其他配置一起持久化。
- **不做额外加密**：本工具定位为个人本地工具，用户对本机有完全控制权，无需过度安全设计。
- **不回显明文**：保存后的凭证在 UI 中仅显示"已设置"或脱敏形式（如 `abc***xyz`），不二次明文展示完整值。
- **不记录日志**：凭证值不出现在任何日志、错误报告或控制台输出中。

### 5) User-Agent 策略

- **由系统内置，不可配置**：减少用户配置复杂度，避免误配导致抓取失败。
- **内置值**：使用常见桌面浏览器的 User-Agent，与正常浏览行为一致。

```
Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
```

说明：后续版本可根据抓取稳定性需求更新内置值，但用户无需关心此配置。

## UI 设计建议

### 凭证输入表单

```
┌─ 凭证设置 ──────────────────────────────────────┐
│                                                  │
│  auth_token *                                    │
│  ┌──────────────────────────────────────────┐   │
│  │                                          │   │
│  └──────────────────────────────────────────┘   │
│  格式：约 40 字符，来自 Cookie "auth_token"       │
│                                                  │
│  ct0 *                                           │
│  ┌──────────────────────────────────────────┐   │
│  │                                          │   │
│  └──────────────────────────────────────────┘   │
│  格式：约 32 字符，来自 Cookie "ct0"              │
│                                                  │
│  [保存并验证]                                     │
│                                                  │
│  ⓘ 如何获取凭证？                                │
│    1. 登录 x.com                                 │
│    2. 按 F12 打开开发者工具                       │
│    3. 切换到 Application → Cookies → x.com       │
│    4. 找到 auth_token 和 ct0，复制其 Value        │
│                                                  │
└──────────────────────────────────────────────────┘
```

### 凭证已配置状态

```
┌─ 凭证设置 ──────────────────────────────────────┐
│                                                  │
│  状态：✓ 已配置（上次验证：2 分钟前，通过）        │
│                                                  │
│  auth_token: abc***xyz                           │
│  ct0: def***uvw                                  │
│                                                  │
│  [重新验证]  [清除并重新输入]                     │
│                                                  │
└──────────────────────────────────────────────────┘
```

## 备选方案 / Alternatives Considered

- **粘贴完整 Cookie 头**：用户从浏览器直接复制整个 Cookie 请求头，后端解析提取所需字段。优点是"一次粘贴"，但用户可能粘贴错误内容（如 Response Cookie），且难以给出精确的字段级错误提示。
- **浏览器扩展自动提取**：开发浏览器扩展自动获取凭证。增加安装步骤和维护成本，不符合"本地小工具"定位。
- **凭证加密存储**：使用系统 keychain 或加密算法保护凭证。增加实现复杂度，且对于本地工具意义有限（攻击者若能读取配置文件，通常也能读取加密密钥）。

## 影响 / Consequences

- ✅ 分字段输入降低用户出错概率，附带示例提升自助成功率。
- ✅ 明确的校验流程和错误提示帮助用户快速定位问题（凭证过期、格式错误等）。
- ✅ 简化的存储与 User-Agent 策略减少配置复杂度和维护成本。
- ⚠️ 用户需手动从浏览器提取凭证，存在一定学习成本（通过帮助文案缓解）。
- ⚠️ 不加密存储意味着任何能读取 `data/config.json` 的进程都能获取凭证（在文档中明确告知用户）。
