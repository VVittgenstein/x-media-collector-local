# 故障排查指南 / Troubleshooting Guide

本文档提供 x-media-collector-local 的常见问题诊断与解决方案。

---

## 排障流程总览

遇到抓取失败时，请按以下顺序排查：

```
1. 检查凭证 → 2. 降低频率 → 3. 启用代理 → 4. 升级抓取库
```

---

## 1. 认证相关问题

### 1.1 错误：401 Unauthorized / 认证失败

**症状**：
- 任务启动后立即失败
- 错误信息包含 "401" 或 "认证失败"

**原因**：
- 凭证未配置或不完整
- 凭证已过期
- 复制凭证时不完整（缺少字符）

**解决步骤**：

1. 确认凭证已配置：打开「设置」页面，检查 auth_token 和 ct0 是否显示"已设置"
2. 重新获取凭证：
   - 在浏览器中登录 x.com
   - 按 F12 打开开发者工具
   - 切换到 Application → Cookies → https://x.com
   - 复制 `auth_token` 和 `ct0` 的完整 Value
3. 在设置页面更新凭证并保存
4. 等待验证通过后重新启动任务

**注意**：复制时确保选中完整的值，不要遗漏首尾字符。

---

### 1.2 错误：403 Forbidden / 访问被拒绝

**症状**：
- 任务失败并显示 "403" 或 "访问被拒绝"
- 可能伴随账号状态提示

**原因**：
- 账号可能被 X 平台临时限制
- 账号权限不足（如私密账号）
- IP 被临时封禁

**解决步骤**：

1. 使用浏览器手动访问 x.com，检查账号是否正常
2. 如果账号被要求验证（手机、邮箱），完成验证后重新获取凭证
3. 等待 1-2 小时后重试
4. 考虑启用代理（见第 3 节）

---

## 2. 限流相关问题

### 2.1 错误：429 Too Many Requests / 请求过于频繁

**症状**：
- 任务运行一段时间后出现 429 错误
- 错误信息包含 "rate limit" 或 "请求过于频繁"

**原因**：
- 请求频率超过平台限制
- 短时间内启动了过多任务

**解决步骤**：

1. **立即停止所有运行中的任务**
2. **等待冷却**：至少等待 5-10 分钟
3. **降低请求频率**：
   - 打开「设置」页面
   - 找到「限流设置」部分
   - 增加 `min_interval_s`（建议设为 2-3 秒）
   - 增加 `jitter_max_s`（建议设为 1-2 秒）
4. **减少并发**：将 `max_concurrent` 降低到 1-2
5. 重新启动任务

**推荐配置（保守）**：

| 参数 | 默认值 | 保守值 |
| ---- | ------ | ------ |
| min_interval_s | 1.5 | 3.0 |
| jitter_max_s | 1.0 | 2.0 |
| max_concurrent | 3 | 1 |

---

### 2.2 频繁超时或连接重置

**症状**：
- 请求经常超时
- 错误信息包含 "timeout" 或 "connection reset"

**原因**：
- 网络不稳定
- 平台主动断开连接（可能是隐性限流）

**解决步骤**：

1. 检查本地网络连接
2. 降低请求频率（同 2.1）
3. 增加重试次数：在设置中将 `max_retries` 设为 5
4. 增加重试间隔：将 `base_delay_s` 设为 3-5 秒
5. 考虑启用代理

---

## 3. 代理配置

### 3.1 何时需要使用代理

- 持续遇到 403/429 错误且降频无效
- IP 被临时封禁
- 需要分散请求来源

### 3.2 代理配置方法

1. 打开「设置」页面
2. 找到「代理设置」部分
3. 勾选「启用代理」
4. 填写代理信息：

```
代理类型：http / https / socks4 / socks5
代理地址：127.0.0.1
代理端口：7890
用户名：（可选）
密码：（可选）
```

5. 保存设置

### 3.3 验证代理是否生效

配置代理后，启动一个小范围任务（如仅采集 10 条），观察：
- 是否仍有 403/429 错误
- 请求是否正常完成

### 3.4 常见代理问题

| 问题 | 可能原因 | 解决方法 |
| ---- | -------- | -------- |
| 连接代理失败 | 代理服务未启动 | 确认代理软件正在运行 |
| 代理认证失败 | 用户名/密码错误 | 检查代理账户信息 |
| 代理速度慢 | 代理服务器负载高 | 更换代理节点 |

---

## 4. 抓取库相关问题

### 4.1 错误：解析错误 / 字段缺失

**症状**：
- 错误信息包含 "parse error"、"KeyError" 或 "field not found"
- 之前正常工作的功能突然失效

**原因**：
- X 平台更新了接口结构
- 当前 twscrape 版本不兼容新接口

**解决步骤**：

1. **升级 twscrape**：

```bash
pip install --upgrade twscrape
```

2. **重启服务**：

```bash
# 停止当前服务（Ctrl+C）
# 重新启动
uvicorn src.backend.app:app --host 127.0.0.1 --port 8000
```

3. 如果升级后仍有问题：
   - 查看 [twscrape GitHub Issues](https://github.com/vladkens/twscrape/issues) 是否有相关讨论
   - 可能需要等待库作者更新

---

### 4.2 错误：scraper error / 抓取异常

**症状**：
- 通用的抓取错误
- 错误信息不够具体

**排查步骤**：

1. 检查凭证是否有效（使用浏览器手动访问 x.com）
2. 升级 twscrape 到最新版本
3. 查看控制台输出的详细错误信息
4. 如果是特定账号失败，检查该账号是否存在或是否为私密账号

---

## 5. 文件系统问题

### 5.1 错误：下载目录不可写

**症状**：
- 任务失败并提示目录权限问题
- 文件无法保存

**解决步骤**：

1. 检查 `download_root` 路径是否存在
2. 确认当前用户对该路径有写权限
3. 如果是网络驱动器，确认已正确挂载
4. 尝试更换到本地路径

---

### 5.2 错误：磁盘空间不足

**症状**：
- 下载过程中失败
- 系统提示磁盘空间不足

**解决步骤**：

1. 清理磁盘空间
2. 更换到空间充足的磁盘路径
3. 减少单次任务的采集范围

---

## 6. ffmpeg 相关问题

### 6.1 错误：ffmpeg 未安装

**症状**：
- 启动时提示 ffmpeg 未找到
- 视频下载失败

**解决步骤**：

```bash
# 安装 ffmpeg
# macOS
brew install ffmpeg

# Ubuntu/Debian
sudo apt update && sudo apt install ffmpeg

# Windows (Chocolatey)
choco install ffmpeg

# Windows (Scoop)
scoop install ffmpeg

# 验证安装
ffmpeg -version
```

---

### 6.2 错误：ffmpeg 处理失败

**症状**：
- 图片下载正常，视频失败
- 错误信息包含 "ffmpeg error"

**可能原因**：
- m3u8 流已过期或不可访问
- ffmpeg 版本过低

**解决步骤**：

1. 确认 ffmpeg 版本：`ffmpeg -version`（建议 4.0+）
2. 如果版本过低，升级 ffmpeg
3. 单个视频失败不影响整体任务，可忽略或后续重试

---

## 7. 获取更多帮助

如果以上方法都无法解决问题：

1. 记录完整的错误信息
2. 记录操作步骤和环境信息（操作系统、Python 版本、twscrape 版本）
3. 查看项目 Issues 是否有类似问题

---

## 附录：常见错误代码速查表

| 错误代码 | 含义 | 首选解决方案 |
| -------- | ---- | ------------ |
| 401 | 认证失败 | 更新凭证 |
| 403 | 访问被拒绝 | 等待或启用代理 |
| 429 | 请求过于频繁 | 降低频率、等待冷却 |
| 500/502/503 | 服务端错误 | 稍后重试 |
| timeout | 请求超时 | 检查网络、增加重试 |
| parse error | 解析错误 | 升级 twscrape |
